<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Badges</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .error { color: red; background: #ffe6e6; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .success { color: green; background: #e6ffe6; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .info { color: blue; background: #e6f3ff; padding: 10px; border-radius: 5px; margin: 10px 0; }
        button { padding: 10px 20px; margin: 10px 5px; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 5px; overflow-x: auto; white-space: pre-wrap; }
        .badge { display: inline-block; padding: 5px 10px; margin: 5px; background: #e6f3ff; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>Debug Badges</h1>
    
    <div id="results"></div>
    
    <h2>Debug Actions</h2>
    <button onclick="checkUser()">1. Kontrollera Användare</button>
    <button onclick="loadBadges()">2. Ladda Badges</button>
    <button onclick="loadUserBadges()">3. Ladda Användarens Badges</button>
    <button onclick="testAwardBadge()">4. Testa Tjäna Badge</button>
    <button onclick="clearResults()">Rensa</button>
    
    <script>
        const supabaseUrl = 'https://edbbestqdwldryxuxkma.supabase.co'
        const supabaseKey = 'sb_publishable_bx81qdFnpcX79ovYbCL98Q_eirRtByp'
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey)
        
        let currentUser = null
        let allBadges = []
        let userBadges = []
        
        async function checkUser() {
            addResult('=== KONTROLLERA ANVÄNDARE ===', 'info')
            
            try {
                const { data: { user }, error } = await supabase.auth.getUser()
                
                if (error) {
                    addResult('❌ Fel vid hämtning av användare: ' + JSON.stringify(error, null, 2), 'error')
                    return
                }
                
                if (!user) {
                    addResult('❌ Ingen användare inloggad', 'error')
                    addResult('Logga in först i huvudapplikationen, sedan kom tillbaka hit', 'info')
                    return
                }
                
                currentUser = user
                addResult('✅ Användare inloggad: ' + user.email, 'success')
                addResult('User ID: ' + user.id, 'info')
                
            } catch (error) {
                addResult('❌ Fel: ' + error.message, 'error')
            }
        }
        
        async function loadBadges() {
            addResult('=== LADDA BADGES ===', 'info')
            
            try {
                const { data: badges, error } = await supabase
                    .from('badges')
                    .select('*')
                    .order('created_at', { ascending: true })
                
                if (error) {
                    addResult('❌ Fel vid laddning av badges: ' + JSON.stringify(error, null, 2), 'error')
                    return
                }
                
                allBadges = badges || []
                addResult('✅ Laddade ' + allBadges.length + ' badges', 'success')
                
                // Show some badges
                const sampleBadges = allBadges.slice(0, 5)
                addResult('Exempel badges:', 'info')
                sampleBadges.forEach(badge => {
                    addResult(`- ${badge.name} (${badge.category})`, 'info')
                })
                
            } catch (error) {
                addResult('❌ Fel: ' + error.message, 'error')
            }
        }
        
        async function loadUserBadges() {
            addResult('=== LADDA ANVÄNDARENS BADGES ===', 'info')
            
            if (!currentUser) {
                addResult('❌ Ingen användare inloggad. Kör steg 1 först.', 'error')
                return
            }
            
            try {
                const { data: userBadgeData, error } = await supabase
                    .from('user_badges')
                    .select(`
                        *,
                        badges (
                            name,
                            description,
                            icon,
                            category,
                            rarity
                        )
                    `)
                    .eq('user_id', currentUser.id)
                    .order('unlocked_at', { ascending: false })
                
                if (error) {
                    addResult('❌ Fel vid laddning av användarens badges: ' + JSON.stringify(error, null, 2), 'error')
                    return
                }
                
                userBadges = userBadgeData || []
                addResult('✅ Laddade ' + userBadges.length + ' användarens badges', 'success')
                
                if (userBadges.length === 0) {
                    addResult('ℹ️ Användaren har inga badges än', 'info')
                } else {
                    addResult('Användarens badges:', 'info')
                    userBadges.forEach(ub => {
                        addResult(`- ${ub.badges.name} (${ub.badges.category}) - ${ub.unlocked_at}`, 'info')
                    })
                }
                
            } catch (error) {
                addResult('❌ Fel: ' + error.message, 'error')
            }
        }
        
        async function testAwardBadge() {
            addResult('=== TESTA TJÄNA BADGE ===', 'info')
            
            if (!currentUser) {
                addResult('❌ Ingen användare inloggad. Kör steg 1 först.', 'error')
                return
            }
            
            if (allBadges.length === 0) {
                addResult('❌ Inga badges laddade. Kör steg 2 först.', 'error')
                return
            }
            
            try {
                // Find a badge the user doesn't have
                const userBadgeIds = userBadges.map(ub => ub.badge_id)
                const availableBadge = allBadges.find(badge => !userBadgeIds.includes(badge.id))
                
                if (!availableBadge) {
                    addResult('ℹ️ Användaren har redan alla badges', 'info')
                    return
                }
                
                addResult('Försöker tjäna badge: ' + availableBadge.name, 'info')
                
                const { data: insertData, error: insertError } = await supabase
                    .from('user_badges')
                    .insert({
                        user_id: currentUser.id,
                        badge_id: availableBadge.id,
                        unlocked_at: new Date().toISOString(),
                        progress: 1
                    })
                    .select()
                
                if (insertError) {
                    addResult('❌ Fel vid tjäna badge: ' + JSON.stringify(insertError, null, 2), 'error')
                } else {
                    addResult('✅ Badge tjänad framgångsrikt: ' + availableBadge.name, 'success')
                    addResult('Insert data: ' + JSON.stringify(insertData, null, 2), 'info')
                    
                    // Reload user badges
                    await loadUserBadges()
                }
                
            } catch (error) {
                addResult('❌ Fel: ' + error.message, 'error')
            }
        }
        
        function addResult(message, type) {
            const div = document.createElement('div')
            div.className = type
            div.innerHTML = message
            document.getElementById('results').appendChild(div)
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = ''
        }
        
        // Initialize
        addResult('Debug redo. Kör stegen i ordning.', 'info')
        addResult('1. Logga in i huvudapplikationen först', 'info')
        addResult('2. Kom tillbaka hit och kör stegen', 'info')
    </script>
</body>
</html>



